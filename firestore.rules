rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to validate artist name format
    function isValidArtistName(name) {
      return name is string &&
             name.size() >= 2 &&
             name.size() <= 50 &&
             name.matches('^[a-zA-Z0-9\\s\\-_]+$');
    }
    
    // Helper function to check if user owns the artist
    function isArtistOwner(artistId) {
      return request.auth != null &&
             get(/databases/$(database)/documents/artists/$(artistId)).data.ownerId == request.auth.uid;
    }
    
    // Helper function to validate conversation title format
    function isValidConversationTitle(title) {
      return title is string &&
             title.size() >= 1 &&
             title.size() <= 100 &&
             title.matches('^[a-zA-Z0-9\\s\\-_]+$');
    }
    
    match /artists/{artistId} {
      // Anyone authenticated can read artists
      allow read: if request.auth != null;
      
      // Create artist - validate name format and ownership
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.ownerId &&
                    isValidArtistName(request.resource.data.name) &&
                    request.resource.data.nameLowercase == request.resource.data.name.lower() &&
                    request.resource.data.deletedAt == null;
      
      // Update artist - validate ownership and name format
      allow update: if request.auth != null &&
                    isArtistOwner(artistId) &&
                    isValidArtistName(request.resource.data.name) &&
                    request.resource.data.nameLowercase == request.resource.data.name.lower() &&
                    request.resource.data.ownerId == resource.data.ownerId &&
                    request.resource.data.deletedAt == null;
      
      // No hard deletes - use soft delete via deletedAt
      allow delete: if false;
    }
    
    // Conversations: Users can only access conversations they're in
    match /conversations/{conversationId} {
      allow read: if request.auth != null && request.auth.uid in resource.data.participants;
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;
      // Allow update if user is participant AND (updating lastMessageAt/lastMessagePreview OR creator updating title)
      allow update: if request.auth != null && 
                     request.auth.uid in resource.data.participants &&
                     (
                       // Updating last message info (any participant)
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastMessageAt', 'lastMessagePreview', 'updatedAt'])) ||
                       // Creator updating title
                       (request.auth.uid == resource.data.createdBy &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['title', 'updatedAt']) &&
                        (request.resource.data.title == null || isValidConversationTitle(request.resource.data.title)) &&
                        request.resource.data.participants == resource.data.participants &&
                        request.resource.data.type == resource.data.type)
                     );
    }
    
    // Messages: Users can only send/read messages in conversations they're in
    match /messages/{messageId} {
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
                     request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.senderId &&
                       exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)) &&
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.participants;
      allow update: if request.auth != null && request.auth.uid == resource.data.senderId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.senderId;
    }
    
    // Other collection rules...
    match /{document=**} {
      allow read, write: if false; // Deny by default
    }
  }
}
